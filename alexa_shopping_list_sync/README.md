# alexa-shopping-list-sync

[![Python](https://img.shields.io/badge/Python-3776AB?style=for-the-badge&logo=python&logoColor=white)](https://www.python.org/)
[![Code style: black](https://img.shields.io/badge/code%20style-black-000000.svg?style=for-the-badge)](https://github.com/psf/black)

A Home Assistant add-on to sync Alexa shopping list with Home Assistant shopping list.

Like my work? Consider buying me a coffee!

[![ko-fi](https://ko-fi.com/img/githubbutton_sm.svg)](https://ko-fi.com/E1E6P7VIQ)

## Setup
You must use an Amazon account that has 2-step verification enabled.

Set your `email`, `password`, `mfa_secret`, `login_url`, `list_url`, `ha_token` and `ha_url` within the Configuration tab of the add-on.

To get the `mfa_secret`, `login_url` and `list_url` follow the instructions below.

#### Setup 2-step verification and get `mfa_secret`
1. Login to Amazon https://www.amazon.co.uk/ or your local Amazon site.

**If you don't have 2-step verification enabled:**

2. Go to `Your Account` => `Login & Security` and click on `Turn On` under `2-step verification`
3. Select the Authentication App

Proceed to step 4 below.

**If you already have 2-step verification enabled:**

2. Go to `Your Account` => `Login & Security` and click on `Manage` under `2-step verification`
3. Under `Authenticator App`, click on `Add new app`

Proceed to step 4 below.

**For both cases:**

4. Click on `Can't scan the barcode` look for the key (13 sets of 4 characters each)
5. Remove the spaces from the key (you will have something like this "ASDMASDFMSKDMKSFMKLASDDADABB6JNRNF7WFEHQW23H238R7843")
6. Add this key to `mfa_secret` under the Configuration tab of the add-on.
7. Click away from the "Can't scan the barcode" popup and you will see the QR code again. Scan this code with your Authenticator App.
8. Enter the code from your Authenticator App and click on `Verify OTP and continue`

#### Getting `login_url` and `list_url`

1. Login to Amazon https://www.amazon.co.uk/ or your local Amazon site.
2. Hover over `Account & Lists` and click on `Alexa Shopping List` under `Your Lists`
3. Copy the URL from the address bar. Add this URL to the `list_url` under the Configuration tab of the add-on.
4. Logout from Amazon
5. Visit your `list_url` (you should see a log-in screen) and copy the URL from the address bar. Add this URL to the `login_url` under the Configuration tab of the add-on.

#### Getting `ha_token` and `ha_url`

This token can be generated by clicking on your username in the bottom left corner of the Home Assistant UI, then click on the `Security` tab and then click on `Create Token` under `Long-Lived Access Tokens`.

The `ha_url` is the WebSocket URL of your Home Assistant instance. This is usually ws://homeassistant.local:8123/api/websocket but you can find it by clicking on `Settings` => `System` => `Network` => `Home Assistant URL`. If you are using SSL (HTTPS), you will need to use wss:// instead of ws://. For example mine is `wss://example.com/api/websocket`.

#### Home Assistant Setup

The add-on will automatically add Alexa shopping list items to your Home Assistant shopping list every minute. You can then use the following automations to sync changes made to your Home Assistant shopping list back to Alexa. You can add these automations to your `automations.yaml` file.

```yaml
automation:
  - id: 4d7ac4e1-4fe1-4abe-b87d-a304208e4388
    alias: "ASLS: Add new shopping list item to Alexa"
    trigger:
      - platform: event
        event_type: shopping_list_updated
        event_data:
          action: "add"
    action:
      service: rest_command.add_shopping_list_item
      data_template:
        item: "{{ trigger.event.data.item.name }}"

  # - id: 8ca2d6b3-97db-4465-b48d-26facff1853e
  #   alias: "ASLS: Update shopping list item on Alexa"
  #   trigger:
  #     - platform: event
  #       event_type: shopping_list_updated
  #       event_data:
  #         action: "update"
  #   action:
  #     service: rest_command.update_shopping_list_item
  #     data_template:
  #       item: "{{ trigger.event.data.item.name }}"
  #       new_item: "{{ trigger.event.data.new_item.name }}"

  - id: abde7a51-104b-4db7-aea6-d08f00e71ef1
    alias: "ASLS: Complete shopping list item on Alexa"
    trigger:
      - platform: event
        event_type: shopping_list_updated
        event_data:
          action: "update"
    condition:
      - condition: template
        value_template: "{{ trigger.event.data.item.complete == true }}"
    action:
      service: rest_command.complete_shopping_list_item
      data_template:
        item: "{{ trigger.event.data.item.name }}"

  - id: 62eac98e-c205-4aba-b48e-558e9d220fc8
    alias: "ASLS: Remove shopping list item from Alexa"
    trigger:
      - platform: event
        event_type: shopping_list_updated
        event_data:
          action: "remove"
    action:
      service: rest_command.remove_shopping_list_item
      data_template:
        item: "{{ trigger.event.data.item.name }}"

rest_command:
  add_shopping_list_item:
    url: "http://localhost:5000/add_item"
    method: post
    payload: '{"item": "{{ item }}"}'
    headers:
      Content-Type: application/json

  update_shopping_list_item:
    url: "http://localhost:5000/update_item"
    method: put
    payload: '{"item": "{{ item }}", "new_item": "{{ new_item }}"}'
    headers:
      Content-Type: application/json

  complete_shopping_list_item:
    url: "http://localhost:5000/complete_item"
    method: put
    payload: '{"item": "{{ item }}"}'
    headers:
      Content-Type: application/json

  remove_shopping_list_item:
    url: "http://localhost:5000/remove_item"
    method: post
    payload: '{"item": "{{ item }}"}'
    headers:
      Content-Type: application/json
```